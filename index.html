<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barcelona Metro Project</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fuse.js (search) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <style>
    :root {
      --bg: #0f0f12;        /* charcoal */
      --fg: #f5f5f7;        /* off-white */
      --muted: #9aa0a6;
      --card: #17171b;
      --accent: #ff4655;    /* you can tweak */
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      display: grid; grid-template-rows: auto 1fr;
    }
    header {
      padding: 16px 20px; border-bottom: 1px solid #232327;
      display: flex; gap: 16px; align-items: center; justify-content: space-between;
    }
    .brand { font-weight: 650; letter-spacing: .2px; }
    .progress { font-size: 14px; color: var(--muted); }
    main {
      display: grid; grid-template-columns: 1fr 420px; gap: 0;
      height: calc(100vh - 64px);
    }
    #map { width: 100%; height: 100%; }
    aside {
      border-left: 1px solid #232327; height: 100%;
      display: grid; grid-template-rows: auto 1fr;
      background: #0f0f12cc; backdrop-filter: blur(4px);
    }
    .controls { padding: 14px; display: grid; gap: 12px; border-bottom: 1px solid #232327; }
    .search {
      display: flex; gap: 8px; align-items: center;
      background: var(--card); border-radius: var(--radius); padding: 10px 12px;
    }
    .search input {
      background: transparent; border: 0; outline: 0; color: var(--fg); width: 100%;
    }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      font-size: 12px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid #2a2a30; cursor: pointer; user-select: none;
    }
    .chip.active { border-color: var(--accent); color: var(--accent); }
    .list { overflow: auto; padding: 10px 10px 18px; }
    .card {
      background: var(--card); border: 1px solid #232327; border-radius: var(--radius);
      padding: 12px; margin: 10px; display: grid; gap: 8px; cursor: pointer;
    }
    .meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .badge {
      font-size: 11px; padding: 4px 8px; border-radius: 999px; background: #202028; border: 1px solid #2a2a30;
    }
    .visited { color: #69db7c; border-color: #2f5d3a; background: #18311f; }
    .thumbs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .thumbs img { width: 100%; height: 84px; object-fit: cover; border-radius: 10px; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; background: #000000a8; display: none;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal.open { display: flex; }
    .sheet {
      width: min(920px, 100%); max-height: 85vh; overflow: auto;
      background: var(--card); border: 1px solid #232327; border-radius: 20px; padding: 18px;
      display: grid; gap: 14px;
    }
    .sheet .gallery { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; }
    .sheet .gallery img { width: 100%; height: 220px; object-fit: cover; border-radius: 12px; }
    .close {
      position: sticky; top: 0; margin-left: auto; background: #202028; border: 1px solid #2a2a30;
      color: var(--fg); padding: 6px 10px; border-radius: 999px; cursor: pointer;
    }

    /* Leaflet dark tweak */
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #202028; color: var(--fg); }
    .leaflet-control-zoom a { background: #202028; color: var(--fg); border: 1px solid #2a2a30; }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
      aside { position: absolute; inset: auto 0 0 0; height: 40vh; }
    }
      /* Modal overrides to ensure visibility */
    .modal { z-index: 10000; }
    .sheet { box-shadow: 0 24px 80px rgba(0,0,0,.6); animation: pop .18s ease-out; }
    @keyframes pop { from { opacity: 0; transform: translateY(6px) scale(.98); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>
  <header>
    <div class="brand">Barcelona Metro Project</div>
    <div class="progress" id="progress">Loading…</div>
  </header>

  <main>
    <div id="map" role="region" aria-label="Map of Barcelona metro stations"></div>
    <aside>
      <div class="controls">
        <div class="search">
          <input id="search" type="search" placeholder="Search stations, tags, lines…" aria-label="Search" />
        </div>
        <div class="chips" id="lineChips" aria-label="Line filters"></div>
      </div>
      <div class="list" id="list" aria-live="polite"></div>
    </aside>
  </main>

  <!-- Modal for Station Detail -->
  <div class="modal" id="modal" aria-hidden="true" aria-label="Station details">
    <div class="sheet" id="sheet">
      <button class="close" id="closeBtn" aria-label="Close details">Close</button>
      <div id="sheetContent"></div>
    </div>
  </div>

  <script>
    // ------------------------------
    // Globals & DOM refs
    // ------------------------------
    let STATION_DATA = [];
    let fuse; // Fuse.js instance (set after data loads)

    const LINE_COLORS = {
      L1: "#e1332d", L2: "#7a2d7a", L3: "#007f4e", L4: "#f0c30f", L5: "#0079c1",
      L9N: "#ef7d00", L9S: "#ef7d00", L10N: "#00a8b5", L10S: "#00a8b5", L11: "#84bd00"
    };

    const listEl = document.getElementById("list");
    const chipsEl = document.getElementById("lineChips");
    const progressEl = document.getElementById("progress");
    const modal = document.getElementById("modal");
    const sheetContent = document.getElementById("sheetContent");
    const searchInput = document.getElementById("search");

    // Map
    const map = L.map("map", { zoomControl: true }).setView([41.387, 2.17], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const markers = [];
    const activeLines = new Set(); // empty = all
    let searchQuery = "";

    document.getElementById("closeBtn").onclick = () => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    };
    modal.addEventListener("click", (e) => { if (e.target === modal) { modal.classList.remove("open"); modal.setAttribute("aria-hidden", "true"); } });

    // ------------------------------
    // Data loader
    // ------------------------------
    function loadStations() {
      // Cache-bust with version param if needed
      const dataUrl = new URL('stations.json', window.location.href);
      // cache-bust to avoid stale copies
      dataUrl.searchParams.set('v', Date.now().toString());
      return fetch(dataUrl)
        .then((r) => { if (!r.ok) throw new Error(`stations.json not found (HTTP ${r.status})`); return r.json(); })
        .then((data) => { STATION_DATA = data; }); return r.json(); }
          

    // ------------------------------
    // UI builders (run AFTER data loads)
    // ------------------------------
    function buildLineChips() {
      chipsEl.innerHTML = "";
      const allLines = [...new Set(STATION_DATA.flatMap((s) => s.lines))].sort();
      allLines.forEach((line) => {
        const chip = document.createElement("button");
        chip.className = "chip";
        chip.textContent = line;
        chip.style.borderColor = LINE_COLORS[line] || "#2a2a30";
        chip.onclick = () => {
          if (activeLines.has(line)) activeLines.delete(line); else activeLines.add(line);
          chip.classList.toggle("active");
          render();
        };
        chipsEl.appendChild(chip);
      });
    }

    function setupSearch() {
      fuse = new Fuse(STATION_DATA, { keys: ["name", "tags", "lines"], threshold: 0.3, includeScore: false });
      searchInput.addEventListener("input", (e) => { searchQuery = e.target.value.trim(); render(); });
    }

    // ------------------------------
    // Helpers
    // ------------------------------
    function stationMatchesFilters(s) {
      const lineOk = activeLines.size === 0 || (Array.isArray(s.lines) && s.lines.some((l) => activeLines.has(l)));
      const statusOk = true; // reserved for future status filter
      if (!searchQuery) return lineOk && statusOk;
      // Guard: if fuse not ready yet, treat as no search results
      if (!fuse) return false;
      const results = new Set(fuse.search(searchQuery).map((r) => r.item.slug));
      return lineOk && statusOk && results.has(s.slug);
    }

    function markerForStation(s) {
      const color = LINE_COLORS[s.lines?.[0]] || "#888";
      const icon = L.divIcon({
        html: `<div style="background:${color}; width:12px; height:12px; border-radius:50%; outline: 2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.4);"></div>`,
        className: "", iconSize: [12, 12]
      });
      const m = L.marker(s.coords, { icon }).addTo(map).bindPopup(`<b>${s.name}</b><br>${(s.lines||[]).join(" · ")}`);
      m.on("click", () => openStation(s));
      return m;
    }

    function openStation(s) {
  const gallery = (s.gallery || []).slice(0, 3);

  let html = '';
  html += '<h2 style="margin:6px 0 4px">' + s.name + '</h2>';
  html += '<div class="meta">';
  (s.lines || []).forEach((l) => {
    html += '<span class="badge" style="border-color:' + (LINE_COLORS[l] || '#2a2a30') + '">' + l + '</span>';
  });
  if (s.visited) {
    html += '<span class="badge visited">Visited' + (s.visitedDate ? ' · ' + s.visitedDate : '') + '</span>';
  }
  if (s.district) {
    html += '<span class="badge">' + s.district + '</span>';
  }
  html += '</div>';

  if (gallery.length) {
    html += '<div class="gallery">';
    html += '<img src="' + gallery[0] + '" alt="Photo of ' + s.name + '">';
    for (let i = 1; i < gallery.length; i++) {
      html += '<img src="' + gallery[i] + '" alt="Photo of ' + s.name + '">';
    }
    html += '</div>';
  }

  const acts = s.activities || [];
  if (acts.length) {
    html += '<div><h3 style="margin:12px 0 6px; font-size:15px;">Activities</h3><ul>';
    acts.forEach((a) => {
      html += '<li><b>' + a.title + '</b> — ' + (a.note || '') + '</li>';
    });
    html += '</ul></div>';
  }

  if (s.notes) html += '<p style="color:var(--muted)">' + s.notes + '</p>';

  const tags = s.tags || [];
  if (tags.length) {
    html += '<div class="meta">';
    tags.forEach((t) => { html += '<span class="badge">#' + t + '</span>'; });
    html += '</div>';
  }

  sheetContent.innerHTML = html;
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
}


    // ------------------------------
    // Render
    // ------------------------------
    function render() {
      // Progress
      const visited = STATION_DATA.filter((s) => s.visited).length;
      progressEl.textContent = `${visited}/${STATION_DATA.length} stations visited`;

      // Clear markers
      markers.forEach((m) => map.removeLayer(m));
      markers.length = 0;

      // Filtered stations
      const filtered = STATION_DATA.filter(stationMatchesFilters).sort((a, b) => a.name.localeCompare(b.name));

      // Re-add markers & list
      listEl.innerHTML = "";
      filtered.forEach((s) => {
        const marker = markerForStation(s);
        markers.push(marker);

        const card = document.createElement("div");
        card.className = "card";
        const linesHtml   = (s.lines || []).map((l) =>
  '<span class="badge" style="border-color:' + (LINE_COLORS[l] || '#2a2a30') + '">' + l + '</span>'
).join('');

const thumbsHtml  = (s.gallery || []).slice(0, 3).map((src) =>
  '<img src="' + src + '" alt="Thumbnail of ' + s.name + '">'
).join('');

const tagsHtml    = (s.tags || []).slice(0, 3).map((t) =>
  '<span class="badge">#' + t + '</span>'
).join('');

card.innerHTML = `
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <div style="font-weight:600">${s.name}</div>
    <div class="meta">${linesHtml}</div>
  </div>
  ${thumbsHtml ? '<div class="thumbs">' + thumbsHtml + '</div>' : ''}
  <div class="meta">
    ${s.visited ? '<span class="badge visited">Visited</span>' : '<span class="badge">Planned</span>'}
    ${s.district ? '<span class="badge">' + s.district + '</span>' : ''}
    ${tagsHtml}
  </div>
`;

        card.onclick = () => { openStation(s); map.setView(s.coords, 15); };
        listEl.appendChild(card);
      });

      // Fit map to filtered markers
      if (filtered.length) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    // ------------------------------
    // App bootstrap
    // ------------------------------
    function init() {
      if (!Array.isArray(STATION_DATA)) {
        console.error("STATION_DATA is not an array", STATION_DATA);
        progressEl.textContent = "Error: bad data format";
        listEl.innerHTML = "<p style='padding:12px;color:#bbb'>Data format error.</p>";
        return;
      }
      buildLineChips();
      setupSearch();
      render();
    }

    // Load data then init
    loadStations().then(init).catch((err) => {
      console.error("Data load failed:", err);
      listEl.innerHTML = "<p style='padding:12px;color:#bbb'>Couldn’t load stations.json</p>";
      progressEl.textContent = "Error loading data";
    });
  </script>
</body>
</html>
