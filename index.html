<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barcelona Metro Project</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fuse.js (search) -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <!-- favicon upload -->
   <link rel="icon" type="image/png" href="photos/favicon.png?v=1">


  <style>
    :root {
      --bg: #0f0f12;        /* charcoal */
      --fg: #f5f5f7;        /* off-white */
      --muted: #9aa0a6;
      --card: #17171b;
      --accent: #ff4655;    /* you can tweak */
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      display: grid; grid-template-rows: auto 1fr;
    }
    header {
      padding: 16px 20px; border-bottom: 1px solid #232327;
      display: flex; gap: 16px; align-items: center; justify-content: space-between;
    }
    .brand { font-weight: 650; letter-spacing: .2px; }
    .progress { font-size: 14px; color: var(--muted); }
    main {
      display: grid; grid-template-columns: 1fr 420px; gap: 0;
      height: calc(100vh - 64px);
    }
    #map { width: 100%; height: 100%; }
    aside {
      border-left: 1px solid #232327; height: 100%;
      display: grid; grid-template-rows: auto 1fr;
      background: #0f0f12cc; backdrop-filter: blur(4px);
    }
    .controls { padding: 14px; display: grid; gap: 12px; border-bottom: 1px solid #232327; }
    .search { display: flex; gap: 8px; align-items: center; background: var(--card); border-radius: var(--radius); padding: 10px 12px; }
    .search input { background: transparent; border: 0; outline: 0; color: var(--fg); width: 100%; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid #2a2a30; cursor: pointer; user-select: none; }
    .chip.active { border-color: var(--accent); color: var(--accent); }
    .list { overflow: auto; padding: 10px 10px 18px; }
    .card { background: var(--card); border: 1px solid #232327; border-radius: var(--radius); padding: 12px; margin: 10px; display: grid; gap: 8px; cursor: pointer; }
    .meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; background: #202028; border: 1px solid #2a2a30; }
    .visited { color: #69db7c; border-color: #2f5d3a; background: #18311f; }
    .thumbs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .thumbs img { width: 100%; height: 84px; object-fit: cover; border-radius: 10px; }

    /* Station detail modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100000; }
    .modal.open { display: flex; }
    .sheet { width: min(920px, 100%); max-height: 85vh; overflow: auto; background: var(--card); border: 1px solid #232327; border-radius: 20px; padding: 18px; display: grid; gap: 14px; box-shadow: 0 24px 80px rgba(0,0,0,.65); position: relative; z-index: 100001; animation: pop .18s ease-out; }
    .close { position: sticky; top: 0; margin-left: auto; background: #202028; border: 1px solid #2a2a30; color: var(--fg); padding: 6px 10px; border-radius: 999px; cursor: pointer; }
    @keyframes pop { from { opacity: 0; transform: translateY(6px) scale(.98); } to { opacity: 1; transform: none; } }

    /* Leaflet tweak & stacking reset under modal */
    #map { position: relative; z-index: 0; }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #202028; color: var(--fg); }
    .leaflet-control-zoom a { background: #202028; color: var(--fg); border: 1px solid #2a2a30; }
    .leaflet-pane, .leaflet-top, .leaflet-bottom { z-index: 0 !important; }

    /* Lock background when any modal is open */
    body.modal-open { overflow: hidden; }

    /* Station detail gallery (scrollable row + arrows, no visible scrollbar) */
    .sheet { overflow-x: hidden; }
    .sheet .gallery-wrap { position: relative; overflow: hidden; }
    .sheet .gallery-row { display: flex; gap: 8px; overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth; padding-bottom: 4px; scroll-snap-type: x mandatory; -ms-overflow-style: none; scrollbar-width: none; }
    .sheet .gallery-row::-webkit-scrollbar { display: none; }
    .sheet .gallery-row img { height: 220px; width: auto; border-radius: 12px; flex: 0 0 auto; cursor: pointer; scroll-snap-align: start; }
    .gallery-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: #202028; border: 1px solid #2a2a30; color: var(--fg); border-radius: 999px; padding: 8px 10px; cursor: pointer; z-index: 2; box-shadow: 0 4px 16px rgba(0,0,0,.25); }
    .gallery-arrow.left  { left: 6px; }
    .gallery-arrow.right { right: 6px; }
    .sheet .gallery-wrap::before, .sheet .gallery-wrap::after { content: ""; position: absolute; top: 0; bottom: 0; width: 24px; pointer-events: none; }
    .sheet .gallery-wrap::before { left: 0;  background: linear-gradient(90deg, rgba(15,15,18,1), rgba(15,15,18,0)); }
    .sheet .gallery-wrap::after  { right: 0; background: linear-gradient(270deg, rgba(15,15,18,1), rgba(15,15,18,0)); }

    /* Fullscreen lightbox */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,.92); display: none; align-items: center; justify-content: center; z-index: 100002; }
    .lightbox.open { display: flex; }
    .lightbox-inner { max-width: min(92vw, 1200px); max-height: 90vh; display: grid; gap: 12px; }
    .lightbox img { max-width: 100%; max-height: 70vh; border-radius: 12px; }
    .lightbox .caption { color: var(--fg); text-align: center; font-size: 14px; opacity: .9; }
    .lightbox .lb-btn { position: absolute; top: 50%; transform: translateY(-50%); background: #202028; border: 1px solid #2a2a30; color: var(--fg); border-radius: 999px; padding: 10px 12px; cursor: pointer; z-index: 100003; }
    .lightbox .lb-prev { left: 24px; }
    .lightbox .lb-next { right: 24px; }
    .lightbox .lb-close { position: absolute; top: 18px; right: 18px; }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
      aside { position: absolute; inset: auto 0 0 0; height: 40vh; }
    }

    /* Ensure both gallery arrows are visible and above the fades */
.sheet .gallery-wrap { position: relative; overflow: hidden; }

/* put fades *under* the arrows */
.sheet .gallery-wrap::before,
.sheet .gallery-wrap::after {
  z-index: 1;
}

/* arrows above everything in the gallery area */
.gallery-arrow {
  z-index: 3;
}

/* position both arrows inside the gallery */
.gallery-arrow.left  { left: 8px; }
.gallery-arrow.right { right: 8px; display: inline-flex; }

/* Extra space between the top badges (.meta) and the gallery */
.sheet #sheetContent > .meta:first-of-type { margin-bottom: 16px; } /* try 16–24px */

/* --- FIX: arrows above images and clickable --- */
.sheet .gallery-wrap { position: relative; }
.sheet .gallery-row { position: relative; z-index: 1; padding: 0 40px; } /* space so arrows aren’t on top of images */
.gallery-arrow { position: absolute; z-index: 5; pointer-events: auto; display: grid; place-items: center; width: 36px; height: 36px; }
.gallery-arrow.left  { left: 8px; }
.gallery-arrow.right { right: 8px; }

/* fades stay under arrows */
.sheet .gallery-wrap::before,
.sheet .gallery-wrap::after { z-index: 2; }

/* --- Gallery arrow overlay fix --- */
.sheet .gallery-wrap { position: relative; }
.sheet .gallery-row { position: relative; z-index: 1; padding: 0 56px; } /* room for arrows */
.sheet .gallery-wrap::before,
.sheet .gallery-wrap::after { z-index: 2; } /* fades under overlay */

.sheet .gallery-overlay {
  position: absolute; inset: 0;
  z-index: 6;                  /* above images & fades */
  pointer-events: none;        /* overlay itself doesn't eat clicks */
}

/* actual buttons DO receive clicks */
.sheet .gallery-overlay .gallery-arrow {
  pointer-events: auto;
  position: absolute; top: 50%; transform: translateY(-50%);
  width: 40px; height: 40px; display: grid; place-items: center;
  background: #202028; border: 1px solid #2a2a30; color: var(--fg);
  border-radius: 999px; box-shadow: 0 6px 18px rgba(0,0,0,.35);
  z-index: 7; /* over everything in overlay */
}
.sheet .gallery-overlay .gallery-arrow.left  { left: 8px; }
.sheet .gallery-overlay .gallery-arrow.right { right: 8px; }

/* --- Station modal gallery (NOT the fullscreen lightbox) --- */
.sheet .gallery-wrap { position: relative; overflow: hidden; }

/* give room so arrows aren't sitting on top of photos */
.sheet .gallery-row { position: relative; z-index: 1; padding: 0 64px; }

/* keep fades under the overlay */
.sheet .gallery-wrap::before,
.sheet .gallery-wrap::after { z-index: 2; }

/* arrow overlay sits above images + fades */
.sheet .gallery-overlay {
  position: absolute; inset: 0;
  z-index: 8;                 /* above images/fades */
  pointer-events: none;       /* overlay itself doesn't eat clicks */
}

/* buttons get the clicks */
.sheet .gallery-overlay .gallery-arrow {
  pointer-events: auto;
  position: absolute; top: 50%; transform: translateY(-50%);
  width: 44px; height: 44px; display: grid; place-items: center;
  background: #202028; border: 1px solid #2a2a30; color: var(--fg);
  border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,.4);
  z-index: 9;
}
.sheet .gallery-overlay .gallery-arrow.left  { left: 12px; }
.sheet .gallery-overlay .gallery-arrow.right { right: 12px; }

/* hide any legacy arrows that might still be in the wrap */
.sheet .gallery-wrap > .gallery-arrow { display: none !important; }

/* --- FORCE station modal arrows above images --- */
.sheet .gallery-wrap { position: relative; overflow: hidden; }

/* give arrows room; override earlier rule */
.sheet .gallery-row {
  position: relative !important;
  z-index: 0 !important;
  padding: 0 64px !important;   /* room for both arrows */
}

/* keep fades under arrows */
.sheet .gallery-wrap::before,
.sheet .gallery-wrap::after { z-index: 1 !important; }

/* arrows: highest layer and clickable */
.sheet .gallery-arrow {
  position: absolute !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  width: 44px; height: 44px;
  display: grid; place-items: center;
  background: #202028; border: 1px solid #2a2a30; color: var(--fg);
  border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,.4);
  z-index: 999 !important;          /* <- wins the stack war */
  pointer-events: auto !important;
}
.sheet .gallery-arrow.left  { left: 12px !important; }
.sheet .gallery-arrow.right { right: 12px !important; }



  </style>
</head>
<body>
  <header>
    <div class="brand">Barcelona Metro Project</div>
    <div class="progress" id="progress">Loading…</div>
  </header>

  <main>
    <div id="map" role="region" aria-label="Map of Barcelona metro stations"></div>
    <aside>
      <div class="controls">
        <div class="search">
          <input id="search" type="search" placeholder="Search stations, tags, lines…" aria-label="Search" />
        </div>
        <div class="chips" id="lineChips" aria-label="Line filters"></div>
      </div>
      <div class="list" id="list" aria-live="polite"></div>
    </aside>
  </main>

  <!-- Station Detail Modal -->
  <div class="modal" id="modal" aria-hidden="true" aria-label="Station details">
    <div class="sheet" id="sheet">
      <button class="close" id="closeBtn" aria-label="Close details">Close</button>
      <div id="sheetContent"></div>
    </div>
  </div>

  <!-- Lightbox modal -->
  <div class="lightbox" id="lightbox" aria-hidden="true" aria-label="Photo viewer">
    <button class="lb-btn lb-prev" id="lbPrev" aria-label="Previous photo">◀</button>
    <button class="lb-btn lb-next" id="lbNext" aria-label="Next photo">▶</button>
    <button class="close lb-close" id="lbClose" aria-label="Close gallery">Close</button>
    <div class="lightbox-inner">
      <img id="lbImg" src="" alt="">
      <div class="caption" id="lbCaption"></div>
    </div>
  </div>

  <script>
    // ------------------------------
    // Globals & DOM refs
    // ------------------------------
    let STATION_DATA = [];
    let fuse; // Fuse.js instance

    const LINE_COLORS = {
      L1: "#e1332d", L2: "#7a2d7a", L3: "#007f4e", L4: "#f0c30f", L5: "#0079c1",
      L9N: "#ef7d00", L9S: "#ef7d00", L10N: "#00a8b5", L10S: "#00a8b5", L11: "#84bd00"
    };

    const listEl = document.getElementById("list");
    const chipsEl = document.getElementById("lineChips");
    const progressEl = document.getElementById("progress");
    const modal = document.getElementById("modal");
    const sheetContent = document.getElementById("sheetContent");
    const searchInput = document.getElementById("search");

    // Lightbox refs
    const lightbox   = document.getElementById('lightbox');
    const lbImg      = document.getElementById('lbImg');
    const lbCaption  = document.getElementById('lbCaption');
    const lbPrev     = document.getElementById('lbPrev');
    const lbNext     = document.getElementById('lbNext');
    const lbClose    = document.getElementById('lbClose');
    let lbGallery = [];
    let lbIndex = 0;

    // Map
    const map = L.map("map", { zoomControl: true }).setView([41.387, 2.17], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap" }).addTo(map);

    const markers = [];
    const activeLines = new Set(); // empty = all
    let searchQuery = "";

    document.getElementById("closeBtn").onclick = () => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("modal-open");
    };
    modal.addEventListener("click", (e) => {
      if (e.target === modal) {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");
        document.body.classList.remove("modal-open");
      }
    });

    // Lightbox controls
    function openLightbox(gallery, startIdx, stationName) {
      lbGallery = gallery.slice();
      lbIndex = Math.max(0, Math.min(startIdx, lbGallery.length - 1));
      updateLightbox(stationName);
      lightbox.classList.add('open');
      lightbox.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-open');
    }
    function updateLightbox(stationName = '') {
      const item = lbGallery[lbIndex];
      if (!item) return;
      lbImg.src = item.src;
      lbImg.alt = item.alt || ('Photo of ' + stationName);
      lbCaption.textContent = item.caption || '';
    }
    function closeLightbox() {
      lightbox.classList.remove('open');
      lightbox.setAttribute('aria-hidden','true');
      document.body.classList.remove('modal-open');
    }
    lbPrev.onclick  = () => { if (!lbGallery.length) return; lbIndex = (lbIndex - 1 + lbGallery.length) % lbGallery.length; updateLightbox(); };
    lbNext.onclick  = () => { if (!lbGallery.length) return; lbIndex = (lbIndex + 1) % lbGallery.length; updateLightbox(); };
    lbClose.onclick = closeLightbox;
    lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
    window.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('open')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lbPrev.click();
      if (e.key === 'ArrowRight') lbNext.click();
    });

    // ------------------------------
    // Data loader
    // ------------------------------
    function loadStations() {
      const dataUrl = new URL('stations.json', window.location.href);
      dataUrl.searchParams.set('v', Date.now().toString()); // cache-bust
      return fetch(dataUrl)
        .then((r) => { if (!r.ok) throw new Error(`stations.json not found (HTTP ${r.status})`); return r.json(); })
        .then((data) => { STATION_DATA = data; });
    }

    // ------------------------------
    // UI builders (run AFTER data loads)
    // ------------------------------
    function buildLineChips() {
      chipsEl.innerHTML = "";
      const allLines = [...new Set(STATION_DATA.flatMap((s) => s.lines))].sort();
      allLines.forEach((line) => {
        const chip = document.createElement("button");
        chip.className = "chip";
        chip.textContent = line;
        chip.style.borderColor = LINE_COLORS[line] || "#2a2a30";
        chip.onclick = () => { if (activeLines.has(line)) activeLines.delete(line); else activeLines.add(line); chip.classList.toggle("active"); render(); };
        chipsEl.appendChild(chip);
      });
    }

    function setupSearch() {
      fuse = new Fuse(STATION_DATA, { keys: ["name", "tags", "lines"], threshold: 0.3, includeScore: false });
      searchInput.addEventListener("input", (e) => { searchQuery = e.target.value.trim(); render(); });
    }

    // ------------------------------
    // Helpers
    // ------------------------------

    // Cache to avoid repeated API calls
const wikiThumbCache = new Map();

/**
 * Try to find a thumbnail for a station via Wikipedia/Commons.
 * Returns Promise<string|null> with a direct HTTPS image URL or null.
 * You can optionally add s.wikiTitle in your stations.json to improve accuracy,
 * e.g. "wikiTitle": "Mundet (Barcelona Metro)"
 */
function ensureWikiThumb(s) {
  const key = s.slug || s.name;
  if (wikiThumbCache.has(key)) return Promise.resolve(wikiThumbCache.get(key));

  // 1) Try Wikipedia pageimages for a station-specific title
  const title = encodeURIComponent(
    s.wikiTitle || (s.name + " (Barcelona Metro)")
  );
  const wp = "https://en.wikipedia.org/w/api.php"
    + "?action=query&format=json&origin=*"
    + "&prop=pageimages"
    + "&piprop=thumbnail&pithumbsize=800"
    + "&titles=" + title;

  return fetch(wp)
    .then(r => r.json())
    .then(j => {
      const pages = j && j.query && j.query.pages ? Object.values(j.query.pages) : [];
      const page = pages[0];
      const src = page && page.thumbnail && page.thumbnail.source;
      if (src) {
        wikiThumbCache.set(key, src);
        return src;
      }
      // 2) Fallback: Commons media search
      const q = encodeURIComponent((s.name + " Barcelona").trim());
      const commons = "https://commons.wikimedia.org/w/api.php"
        + "?action=query&format=json&origin=*"
        + "&generator=search&gsrsearch=" + q + "&gsrlimit=1"
        + "&prop=imageinfo&iiprop=url&iiurlwidth=800";
      return fetch(commons).then(r => r.json()).then(j2 => {
        const pgs = j2 && j2.query && j2.query.pages ? Object.values(j2.query.pages) : [];
        const p = pgs[0];
        const ii = p && p.imageinfo && p.imageinfo[0];
        const url = ii && (ii.thumburl || ii.url);
        wikiThumbCache.set(key, url || null);
        return url || null;
      });
    })
    .catch(() => null);
}

    function normalizeGallery(g) {
      // Supports ["a.jpg","b.jpg"] OR [{src:"a.jpg", caption:"..."}]
      return (g || []).map(item => { if (typeof item === 'string') return { src: item, caption: '', alt: '' }; return { src: item.src, caption: item.caption || '', alt: item.alt || '' }; }).filter(x => x && x.src);
    }

    function stationMatchesFilters(s) {
      const lineOk = activeLines.size === 0 || (Array.isArray(s.lines) && s.lines.some((l) => activeLines.has(l)));
      const statusOk = true; // reserved for future status filter
      if (!searchQuery) return lineOk && statusOk;
      if (!fuse) return false; // Fuse not ready
      const results = new Set(fuse.search(searchQuery).map((r) => r.item.slug));
      return lineOk && statusOk && results.has(s.slug);
    }

    function markerForStation(s) {
      const primaryLine = (Array.isArray(s.lines) && s.lines.length) ? s.lines[0] : null;
      const color = primaryLine ? (LINE_COLORS[primaryLine] || "#888") : "#888";
      const icon = L.divIcon({ html: '<div style="background:' + color + '; width:12px; height:12px; border-radius:50%; outline: 2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.4);"></div>', className: "", iconSize: [12, 12] });
      const m = L.marker(s.coords, { icon }).addTo(map).bindPopup('<b>' + s.name + '</b><br>' + (s.lines||[]).join(' · '));
      m.on("click", () => openStation(s));
      return m;
    }

function openStation(s) {
  const gal = normalizeGallery(s.gallery);

  // Build base HTML
  let html = '';
  html += '<h2 style="margin:6px 0 4px">' + s.name + '</h2>';
  html += '<div class="meta">';
  (s.lines || []).forEach((l) => {
    html += '<span class="badge" style="border-color:' + (LINE_COLORS[l] || '#2a2a30') + '">' + l + '</span>';
  });
  if (s.visited)  html += '<span class="badge visited">Visited' + (s.visitedDate ? ' · ' + s.visitedDate : '') + '</span>';
  if (s.district) html += '<span class="badge">' + s.district + '</span>';
  html += '</div>';

  // Always include a mount for the gallery
  html += '<div id="galleryMount"></div>';

  const acts = s.activities || [];
  if (acts.length) {
    html += '<div><h3 style="margin:12px 0 6px; font-size:15px;">Activities</h3><ul>';
    acts.forEach((a) => { html += '<li><b>' + a.title + '</b> — ' + (a.note || '') + '</li>'; });
    html += '</ul></div>';
  }
  if (s.notes) html += '<p style="color:var(--muted)">' + s.notes + '</p>';

  const tags = s.tags || [];
  if (tags.length) {
    html += '<div class="meta">';
    tags.forEach((t) => { html += '<span class="badge">#' + t + '</span>'; });
    html += '</div>';
  }

  // Inject + open modal
  sheetContent.innerHTML = html;
  modal.classList.add('open');
  modal.setAttribute('aria-hidden', 'false');
  document.body.classList.add('modal-open');

  // Build the gallery DOM
  const mount = document.getElementById('galleryMount');

  if (gal.length) {
// Local images gallery (overlayed arrows)
const wrap  = document.createElement('div');
wrap.className = 'gallery-wrap';

const row   = document.createElement('div');
row.className = 'gallery-row';
row.id = 'gRow';

gal.forEach((g, idx) => {
  const img = document.createElement('img');
  img.src = g.src;
  img.alt = g.alt || ('Photo of ' + s.name);
  img.setAttribute('data-idx', idx);
  img.addEventListener('click', () => openLightbox(gal, idx, s.name));
  row.appendChild(img);
});

// overlay ABOVE the row for always-clickable arrows
const overlay = document.createElement('div');
overlay.className = 'gallery-overlay';

const prev  = document.createElement('button');
prev.className = 'gallery-arrow left';
prev.id = 'gPrev';
prev.setAttribute('aria-label','Scroll left');
prev.textContent = '◀';

const next  = document.createElement('button');
next.className = 'gallery-arrow right';
next.id = 'gNext';
next.setAttribute('aria-label','Scroll right');
next.textContent = '▶';

overlay.appendChild(prev);
overlay.appendChild(next);

wrap.appendChild(row);
wrap.appendChild(overlay);
mount.appendChild(wrap);

// scroll step ~ one image width + 8px gap
const step = () => {
  const firstImg = row.querySelector('img');
  const gapPx = 8;
  return firstImg ? firstImg.clientWidth + gapPx : Math.max(300, row.clientWidth * 0.8);
};
prev.onclick = () => row.scrollBy({ left: -step(), behavior: 'smooth' });
next.onclick = () => row.scrollBy({ left:  step(), behavior: 'smooth' });


  } else {
    // No local images → Wikipedia/Commons fallback
    const wrap = document.createElement('div');
    wrap.className = 'gallery-wrap';
    const row  = document.createElement('div');
    row.className = 'gallery-row';
    row.id = 'gRow';
    wrap.appendChild(row);
    mount.appendChild(wrap);

    const credit = document.createElement('div');
    credit.className = 'caption';
    credit.style.cssText = 'font-size:12px;opacity:.8;margin-top:6px;';
    mount.appendChild(credit);

    ensureWikiThumb(s).then(url => {
      if (url) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Preview of ' + s.name;
        img.addEventListener('click', () =>
          openLightbox([{ src: url, caption: 'Image via Wikipedia/Commons' }], 0, s.name)
        );
        row.appendChild(img);
        credit.textContent = 'Image via Wikipedia/Commons';
      } else {
        row.innerHTML = '<div style="color:#aaa;padding:8px 0;">No photos yet.</div>';
        credit.textContent = '';
      }
    });
  }
}




    // ------------------------------
    // Render
    // ------------------------------
// ------------------------------
// Render
// ------------------------------
function render() {
  const visited = STATION_DATA.filter((s) => s.visited).length;
  progressEl.textContent = `${visited}/${STATION_DATA.length} stations visited`;

  // Clear markers
  markers.forEach((m) => map.removeLayer(m));
  markers.length = 0;

  // Filter + sort
  const filtered = STATION_DATA
    .filter(stationMatchesFilters)
    .sort((a, b) => a.name.localeCompare(b.name));

  // Rebuild list
  listEl.innerHTML = "";
  filtered.forEach((s) => {
    const marker = markerForStation(s);
    markers.push(marker);

    const card = document.createElement("div");
    card.className = "card";

    const linesHtml = (s.lines || []).map((l) =>
      `<span class="badge" style="border-color:${LINE_COLORS[l] || '#2a2a30'}">${l}</span>`
    ).join('');

    const tagsHtml = (s.tags || []).slice(0, 3).map((t) =>
      `<span class="badge">#${t}</span>`
    ).join('');

    const localThumbs = (s.gallery || []).slice(0, 3).map((src) =>
      `<img src="${typeof src === 'string' ? src : src.src}" alt="Thumbnail of ${s.name}">`
    ).join('');

    card.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div style="font-weight:600">${s.name}</div>
        <div class="meta">${linesHtml}</div>
      </div>
      <div class="thumbs" id="thumb-${s.slug}">${localThumbs}</div>
      <div class="meta">
        ${s.visited ? '<span class="badge visited">Visited</span>' : '<span class="badge">Planned</span>'}
        ${s.district ? `<span class="badge">${s.district}</span>` : ''}
        ${tagsHtml}
      </div>
    `;

    // Wikipedia/Commons fallback if no local images
    if (!localThumbs) {
      const mount = card.querySelector(`#thumb-${s.slug}`);
      if (mount) {
        ensureWikiThumb(s).then(url => {
          if (url) {
            mount.innerHTML = `<img src="${url}" alt="Preview of ${s.name} (via Wikipedia)">`;
          } else {
            mount.innerHTML = '';
          }
        });
      }
    }

    card.onclick = () => { openStation(s); map.setView(s.coords, 15); };
    listEl.appendChild(card);
  });

  // Fit bounds to visible markers
  if (filtered.length) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }
}

// ------------------------------
// App bootstrap
// ------------------------------
function init() {
  if (!Array.isArray(STATION_DATA)) {
    console.error("STATION_DATA is not an array", STATION_DATA);
    progressEl.textContent = "Error: bad data format";
    listEl.innerHTML = "<p style='padding:12px;color:#bbb'>Data format error.</p>";
    return;
  }
  buildLineChips();
  setupSearch();
  render();
}

loadStations()
  .then(init)
  .catch((err) => {
    console.error("Data load failed:", err);
    listEl.innerHTML = "<p style='padding:12px;color:#bbb'>Couldn’t load stations.json</p>";
    progressEl.textContent = "Error loading data";
  });



    // ------------------------------
    // App bootstrap
    // ------------------------------
    function init() {
      if (!Array.isArray(STATION_DATA)) {
        console.error("STATION_DATA is not an array", STATION_DATA);
        progressEl.textContent = "Error: bad data format";
        listEl.innerHTML = "<p style='padding:12px;color:#bbb'>Data format error.</p>";
        return;
      }
      buildLineChips();
      setupSearch();
      render();
    }

    loadStations().then(init).catch((err) => {
      console.error("Data load failed:", err);
      listEl.innerHTML = "<p style='padding:12px;color:#bbb'>Couldn’t load stations.json</p>";
      progressEl.textContent = "Error loading data";
    });
  </script>
</body>
</html>
